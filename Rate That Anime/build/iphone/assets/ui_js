function _getTargetFile(e,t,i){var a=Ti.Utils.sha1(e+"_"+t)+e.substr(e.lastIndexOf(".")),r=Ti.Filesystem.getFile(i||Ti.Filesystem.applicationCacheDirectory,a);return r}function _setBackgroundImage(e,t,i){var a,r=e._backgroundImage,o=e._backgroundTarget||t+"_"+i,n=_getTargetFile(r,o);if(n.exists())e.backgroundImage=n.nativePath;else{if(-1!==r.indexOf("://")){a=_getTargetFile(r,"tmp",Ti.Filesystem.tempDirectory);var d=Ti.Network.createHTTPClient({onload:function(){return a.write(this.responseData)?void _resizeBackgroundImage(e,t,i,a,n):void console.error("[UI] Could not write downloaded file to: "+a.nativePath)},onerror:function(e){console.error("[UI] Could not downloaded image: "+e.error)}});return d.open("GET",r),void d.send()}a=Ti.Filesystem.getFile(r),_resizeBackgroundImage(e,t,i,a,n)}}function _resizeBackgroundImage(e,t,i,a,r){if(!a.exists())return void console.error("[UI] backgroundImage not found: "+a.nativePath);var o=a.read(),n=o.width,d=o.height,g=n/d;t=Ti.UI.convertUnits(""+t,Ti.UI.UNIT_PX),i=Ti.UI.convertUnits(""+i,Ti.UI.UNIT_PX);var c,s,l=t/i;l>g?(c=t,s=Math.ceil(c/g)):(s=i,c=Math.ceil(s*g)),(n!==c||d!==s)&&(o=o.imageAsResized(c,s)),(c!==t||s!==i)&&(o=o.imageAsCropped({width:t,height:i})),r.write(o),e.backgroundImage=r.nativePath}function _onPostLayout(e){var t=e.source,i=t.size;t.removeEventListener("postlayout",_onPostLayout),_setBackgroundImage(t,i.width,i.height)}function _isAbsolute(e){return e&&e.toString().match(/^[1-9]+[0-9]*[a-z]*$/)}exports.createView=function(e){if(e.backgroundSize&&"cover"===e.backgroundSize&&e.backgroundImage&&"string"==typeof e.backgroundImage){if(e._backgroundImage=e.backgroundImage,delete e.backgroundImage,e.backgroundTarget){e._backgroundTarget=e.backgroundTarget,delete e.backgroundTarget;var t=_getTargetFile(e._backgroundImage,e._backgroundTarget);if(t.exists())return e.backgroundImage=t.nativePath,Ti.UI.createView(e)}var i=Ti.UI.createView(e);return _isAbsolute(e.width)&&_isAbsolute(e.height)?_setBackgroundImage(i,e.width,e.height):i.addEventListener("postlayout",_onPostLayout),i}return Ti.UI.createView(e)};